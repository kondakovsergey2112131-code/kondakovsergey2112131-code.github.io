<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Добро пожаловать на мой сайт</title>
  <style>
    :root{ --bg1:#6a11cb; --bg2:#2575fc; --muted:#a9b7cc; --card:#0f1322; --border:#2b3963; --ok:#34C759; --err:#FF3B30; }
    *{ box-sizing:border-box }
    body { margin:0; font-family:'Segoe UI',Arial,sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; text-align:center; overflow-x:hidden; }
    header { padding:38px 20px 18px; display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:8px; }
    h1 { flex:1 1 100%; font-size:2.1rem; margin:0 0 6px; }
    p.lead { flex:1 1 100%; font-size:1rem; opacity:.9; margin:0 0 10px; }
    .btn { display:inline-block; margin:6px 6px 0; padding:10px 18px; background:#fff; color:#2575fc; font-weight:700; border-radius:30px; text-decoration:none; transition:.25s; cursor:pointer; border:0; }
    .btn:hover { background:#ffdd57; color:#333; transform:translateY(-1px); }
    .btn.ghost{ background: rgba(255,255,255,.18); color:#fff; border:1px solid rgba(255,255,255,.35); }
    .btn.ghost:hover{ background: rgba(255,255,255,.28); color:#fff; }
    .hello{ display:inline-block; min-width:140px; font-size:.95rem; color:#eaf2ff; opacity:.95; }
    main { padding:18px 20px 40px; }
    img.preview { max-width:320px; border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.35); transition:transform .3s ease; }
    img.preview:hover { transform:rotate(2deg) scale(1.04); }
    footer { background:rgba(0,0,0,.2); padding:12px; font-size:.9rem; }

    /* Overlays */
    .overlay{ display:none; position:fixed; inset:0; z-index:9998; justify-content:center; align-items:center; background:#000; }
    .overlay img{ width:100vw; height:100vh; object-fit:cover; display:block; user-select:none; pointer-events:none; }
    #bsod{ z-index:10000; background:#0078d7; cursor:none; }

    /* Chat widget (bottom-right) */
    #chatWidget{ position:fixed; right:20px; bottom:-420px; width:340px; background:#fff; color:#111; border-radius:16px; box-shadow:0 18px 40px rgba(0,0,0,.35); z-index:5000; overflow:hidden; transition:bottom .5s ease; font-family:"Segoe UI", Arial, sans-serif; }
    body.sv-show #chatWidget{ bottom:20px; }
    #sv-ad{ display:flex; gap:12px; padding:14px; align-items:center; }
    #sv-ad .sv-photo{ flex:0 0 64px; width:64px; height:64px; border-radius:10px; overflow:hidden; }
    #sv-ad .sv-photo img{ width:100%; height:100%; object-fit:cover; display:block; }
    #sv-ad .sv-text{ flex:1; text-align:left; }
    #sv-ad .sv-title{ font-size:18px; font-weight:700; margin:0 0 6px; }
    #sv-ad .sv-sub{ color:#1ea94d; font-size:14px; margin-bottom:8px; }
    #sv-ad .sv-btn{ display:inline-flex; align-items:center; gap:8px; background:#8e44ad; color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    #sv-ad .sv-badge{ width:10px; height:10px; border-radius:50%; background:#ff3b30; box-shadow:0 0 0 2px #8e44ad; }
    #sv-chat{ display:none; flex-direction:column; height:420px; }
    #sv-chat .sv-header{ display:flex; align-items:center; gap:10px; padding:12px 14px; background:#2575fc; color:#fff; user-select:none; }
    #sv-chat .sv-header .sv-avatar{ width:36px; height:36px; border-radius:50%; overflow:hidden; background:#fff; }
    #sv-chat .sv-messages{ flex:1; padding:12px; overflow-y:auto; background:#f7f8fa; }
    .sv-msg{ max-width:82%; margin:6px 0; padding:10px 12px; border-radius:10px; word-wrap:break-word; }
    .sv-from{ background:#fff; border:1px solid #e9edf3; text-align:left; }
    .sv-to{ background:#e7f0ff; margin-left:auto; text-align:left; }
    #sv-chat .sv-input{ display:flex; gap:8px; padding:10px; border-top:1px solid #e6e9ef; background:#fff; }
    #sv-chat .sv-input input{ flex:1; border:1px solid #d8dee9; border-radius:10px; padding:10px; font-size:14px; }
    #sv-chat .sv-input button{ background:#2575fc; color:#fff; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; }

    /* Typing dots */
    .typing{ display:inline-flex; align-items:center; gap:4px; padding:8px 10px; background:#fff; border:1px solid #e9edf3; border-radius:10px; }
    .typing .dot{ width:6px; height:6px; border-radius:50%; background:#9db1cc; animation:jump 1.2s infinite; }
    .typing .dot:nth-child(2){ animation-delay:.15s } .typing .dot:nth-child(3){ animation-delay:.3s }
    @keyframes jump{ 0%,100%{ transform:translateY(0); opacity:.6 } 50%{ transform:translateY(-4px); opacity:1 } }

    /* Call UI */
    .callui-overlay{ position: fixed; inset: 0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.45); backdrop-filter: blur(6px); z-index: 9999; }
    .callui-card{ width: min(92vw, 420px); border-radius: 28px; background: #0B0B0C; color: #fff; padding: 22px 22px 26px; box-shadow: 0 30px 80px rgba(0,0,0,.35); }
    .callui-status{ opacity:.7; font-size:14px; margin-bottom:6px; text-align:center; }
    .callui-title{ text-align:center; font-weight:600; font-size:20px; margin:6px 0 2px; }
    .callui-sub{ text-align:center; opacity:.6; font-size:13px; margin-bottom: 12px; }
    .callui-actions{ display:flex; gap:16px; justify-content:center; }
    .callui-btn{ width:68px; height:68px; border-radius:50%; display:grid; place-items:center; cursor:pointer; border:none; }
    .callui-accept{ background:var(--ok); } .callui-decline{ background:var(--err); }
    .callui-timer{ text-align:center; font-size:16px; font-weight:600; margin-top:10px; color:#67ffb5; min-height:22px; }

    /* AUTH modal */
    .auth-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:12000; backdrop-filter:blur(4px); }
    .auth-card{ width:min(92vw,420px); background:var(--card); color:#e8eef4; border-radius:18px; box-shadow:0 20px 70px rgba(0,0,0,.6); padding:18px; text-align:left; }
    .auth-title{ margin:0 0 8px; font-size:1.1rem; }
    .auth-tabs{ display:flex; gap:6px; margin-bottom:10px; }
    .auth-tab{ flex:1; padding:10px; background:#1c2236; color:#9fb0c8; border:0; border-radius:10px; cursor:pointer; font-weight:700; }
    .auth-tab.active{ background:#2b3963; color:#fff; }
    .auth-field{ margin:8px 0; }
    .auth-field label{ display:block; font-size:12px; color:#9fb0c8; margin-bottom:4px; }
    .auth-field input{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:#131a2d; color:#e8eef4; }
    .auth-actions{ display:flex; gap:8px; margin-top:10px; }
    .auth-actions button{ flex:1; padding:10px; border-radius:10px; border:0; cursor:pointer; font-weight:700; }
    .auth-primary{ background:#4f75ff; color:#fff; } .auth-secondary{ background:#29314a; color:#fff; }
    .auth-error{ color:#ff7676; font-size:12px; min-height:16px; margin-top:6px; }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:13000; display:none; }

    /* Social (community) */
    .social-card{ width:min(96vw,860px); background:#0b1022; color:#e8eef4; border-radius:18px; box-shadow:0 20px 70px rgba(0,0,0,.6); padding:16px; text-align:left; }
    .social-tabs{ display:flex; gap:6px; margin:6px 0 12px; }
    .social-tab{ padding:8px 12px; border-radius:10px; background:#151c35; color:#9fb0c8; border:1px solid #243054; cursor:pointer; }
    .social-tab.active{ background:#243054; color:#fff; }
    .social-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .social-col{ background:#0e1530; border:1px solid #22305a; border-radius:12px; padding:10px; min-height:180px; }
    .social-list{ display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto; }
    .social-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:#0f1836; border:1px solid #263567; border-radius:10px; padding:8px 10px; }
    .social-name{ font-weight:700; } .social-email{ font-size:12px; color:#9fb0c8; } .mini{ font-size:12px; opacity:.8; }
    .social-actions button{ padding:6px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:700; }
    .act{ background:#4f75ff; color:#fff; } .muted{ background:#263567; color:#c7d2fe; } .danger{ background:#7f1d1d; color:#fff; }
    @media (max-width:860px){ .social-grid{ grid-template-columns:1fr; } }

    /* DM */
    .dm-panel{ display:none; background:#0e1530; border:1px solid #22305a; border-radius:12px; padding:10px; min-height:260px; }
    .dm-head{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    .dm-title{ font-weight:800; } .dm-back{ margin-left:auto; background:#263567; color:#c7d2fe; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700; }
    .dm-list{ background:#0f1836; border:1px solid #263567; border-radius:10px; padding:8px; max-height:240px; overflow:auto; display:flex; flex-direction:column; gap:6px; }
    .dm-msg{ display:inline-block; max-width:80%; padding:8px 10px; border-radius:10px; font-size:14px; }
    .dm-me{ align-self:flex-end; background:#263a6b; color:#e7f0ff; } .dm-other{ align-self:flex-start; background:#152246; color:#e0e7ff; }
    .dm-time{ display:block; font-size:11px; opacity:.65; margin-top:2px; }
    .dm-input{ display:flex; gap:8px; margin-top:8px; }
    .dm-input input{ flex:1; padding:10px; border-radius:10px; border:1px solid #263567; background:#0b1029; color:#e8eef4; }
    .dm-input button{ padding:10px 14px; border-radius:10px; border:0; background:#4f75ff; color:#fff; font-weight:700; cursor:pointer; }

    /* Error banner */
    .errban{ position:fixed; left:10px; bottom:10px; z-index:99999; background:#7f1d1d; color:#fff; padding:8px 10px; border-radius:8px; font:12px/1.3 monospace; max-width:80vw; display:none; }
  
    /* Ensure disabled buttons look clickable enough */
    #sv-chat .sv-input button:disabled,
    .dm-input button:disabled { opacity: .6; cursor: not-allowed; }

  
    /* Users Carousel */
    .uc{ margin:0 auto; width:min(92vw, 360px); height:220px; position:relative;
         border-radius:16px; overflow:hidden; box-shadow:0 12px 28px rgba(0,0,0,.35); }
    .uc-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity .8s ease; }
    .uc-img.active{ opacity:1; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
  
  ;(function(){
    const el = document.getElementById('userCarousel');
    if(!el) return;

    function parseSources(attr){
      if(!attr) return [];
      // Try JSON first
      try {
        const arr = JSON.parse(attr);
        if (Array.isArray(arr)) return arr;
      } catch(_) {}
      // Fallback: CSV string "a.jpg, b.jpg, c.png"
      const raw = String(attr).trim();
      const cleaned = raw.replace(/^\[|\]$/g, '');
      const parts = cleaned.split(',').map(s => s.trim().replace(/^['"]|['"]$/g,''));
      return parts.filter(Boolean);
    }

    let sources = parseSources(el.getAttribute('data-images') || '');

    // As a second fallback: take any <img data-src="..."> children
    if(!sources.length){
      const candidates = Array.from(el.querySelectorAll('img[data-src]')).map(i => i.getAttribute('data-src'));
      sources = candidates.filter(Boolean);
    }

    // If still nothing — try to read a single src attr from legacy <img>
    if(!sources.length){
      const candidates = Array.from(el.querySelectorAll('img[src]')).map(i => i.getAttribute('src'));
      sources = candidates.filter(Boolean);
    }

    // Last fallback: use myphoto.jpg if present
    if(!sources.length){ sources = ['myphoto.jpg']; }

    // De-dup
    sources = Array.from(new Set(sources));

    const imgs = [];
    let finished = 0;
    const total = sources.length;
    let hadSuccess = false;

    function done(){
      finished++;
      if(finished < total) return;
      if(!hadSuccess){
        // Visible fallback with hint
        const box = document.createElement('div');
        box.style.position='absolute';
        box.style.inset='0';
        box.style.display='grid';
        box.style.placeItems='center';
        box.style.background='rgba(0,0,0,.2)';
        box.style.color='#fff';
        box.style.font='600 14px/1.3 system-ui, Arial';
        box.textContent = 'Изображения не найдены. Проверьте имена файлов в data-images.';
        el.appendChild(box);
        return;
      }
      // Show first
      let idx = 0;
      imgs[0].classList.add('active');
      let timer = null;
      function next(){
        imgs[idx].classList.remove('active');
        idx = (idx + 1) % imgs.length;
        imgs[idx].classList.add('active');
      }
      function start(){ if(!timer){ timer = setInterval(next, 3000); } }
      function stop(){ if(timer){ clearInterval(timer); timer = null; } }
      start();
      el.addEventListener('mouseenter', stop);
      el.addEventListener('mouseleave', start);
    }

    sources.forEach(src => {
      if(!src) { finished++; return; }
      const img = new Image();
      img.className = 'uc-img';
      img.alt = 'Пользователь';
      img.onload = () => { el.appendChild(img); imgs.push(img); hadSuccess = true; done(); };
      img.onerror = () => { console.warn('[Carousel] Не удалось загрузить', src); done(); };
      // Avoid accidental leading/trailing spaces
      img.src = src.trim();
    });
  })();
</script>
</head>
<body>
  <header>
    <h1>Добро пожаловать на мой сайт</h1>
    <p class="lead">Теперь Светлана отвечает как «ИИ» прямо в чат</p>
    <button class="btn" id="moreBtn">Узнать больше</button>
    <button class="btn ghost" id="authOpen">Войти / Регистрация</button>
    <button class="btn" id="logoutBtn" style="display:none">Выйти</button>
    <button class="btn ghost" id="socialOpen">Сообщество 👥</button>
    <span class="hello" id="hello"></span>
  </header>

  <main>
  <h2 style="margin:0 0 10px">Наши пользователи</h2>
  <div class="uc" id="userCarousel" aria-label="Карусель фото пользователей"
       data-images=\'["myphoto.jpg","svetlana.jpeg","orig.jpg"]\'>
  </div>
</main>

  <footer><p>© 2025</p></footer>

  <!-- Screamer/BSOD -->
  <div id="screamer" class="overlay" aria-hidden="true">
    <img src="screamer.jpg" alt=""><audio id="screamSound" src="scream.mp3"></audio>
  </div>
  <div id="bsod" class="overlay" aria-hidden="true" title="Клик — перезагрузка">
    <img src="bsod.png" alt="">
  </div>

  <!-- Chat widget -->
  <div id="chatWidget" aria-live="polite">
    <div id="sv-ad">
      <div class="sv-photo"><img src="orig.png" alt="Светлана" onerror="this.onerror=null; this.src='orig.jpg';"></div>
      <div class="sv-text">
        <div class="sv-title">Светлана на связи</div>
        <div class="sv-sub"> 300м от Вас </div>
        <button class="sv-btn" id="sv-open"><span>ОТВЕТИТЬ</span><span class="sv-badge"></span></button>
      </div>
    </div>
    <div id="sv-chat">
      <div class="sv-header">
        <div class="sv-avatar"><img src="orig.png" alt="" onerror="this.onerror=null; this.src='orig.jpg';"></div>
        <div class="sv-name">Светлана • ИИ</div>
        <div class="sv-close" id="sv-close" title="Свернуть">×</div>
      </div>
      <div class="sv-messages" id="sv-msgs"><div class="sv-msg sv-from"><b>Светлана:</b> Привет! Я рядом. Чем помочь? 😊</div></div>
      <div class="sv-input"><input type="text" id="sv-input" placeholder="Напишите сообщение…"><button id="sv-send">➤</button></div>
    </div>
  </div>

  <!-- Call overlay -->
  <div class="callui-overlay" id="callui">
    <div class="callui-card">
      <div class="callui-status" id="calluiDesc">Входящий звонок</div>
      <div class="callui-title">Светлана</div>
      <div class="callui-sub">мессенджер чата</div>
      <div class="callui-actions">
        <button class="callui-btn callui-decline" id="calluiDecline" aria-label="Отклонить">⛔</button>
        <button class="callui-btn callui-accept" id="calluiAccept" aria-label="Принять">📞</button>
      </div>
      <div class="callui-timer" id="calluiTimer"></div>
    </div>
  </div>

  <!-- AUTH Modal -->
  <div class="auth-overlay" id="auth">
    <div class="auth-card">
      <h3 class="auth-title" id="authTitle">Вход</h3>
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin">Войти</button>
        <button class="auth-tab" id="tabRegister">Регистрация</button>
      </div>
      <div id="regNameWrap" class="auth-field" style="display:none">
        <label>Имя</label><input type="text" id="regName" placeholder="Как к вам обращаться">
      </div>
      <div class="auth-field"><label>Email</label><input type="email" id="authEmail" placeholder="you@example.com" autocomplete="email"></div>
      <div class="auth-field"><label>Пароль</label><input type="password" id="authPass" placeholder="Минимум 6 символов" autocomplete="current-password"></div>
      <div id="regConfirmWrap" class="auth-field" style="display:none">
        <label>Повторите пароль</label><input type="password" id="authPass2" placeholder="Ещё раз пароль" autocomplete="new-password">
      </div>
      <div class="auth-actions"><button class="auth-secondary" id="authCancel">Отмена</button><button class="auth-primary" id="authSubmit">Продолжить</button></div>
      <div class="auth-error" id="authError"></div>
      <div class="mini">Демо: данные только в вашем браузере (localStorage).</div>
    </div>
  </div>

  <!-- SOCIAL Modal -->
  <div class="auth-overlay" id="social">
    <div class="social-card">
      <div style="display:flex;align-items:center;gap:10px;">
        <h3 style="margin:0">Сообщество</h3>
        <span class="mini" id="socialStatus"></span>
        <button class="btn ghost" id="socialClose" style="margin-left:auto;padding:6px 12px;">Закрыть</button>
      </div>
      <div class="social-tabs">
        <button class="social-tab active" id="tabUsers">Пользователи</button>
        <button class="social-tab" id="tabRequests">Заявки</button>
        <button class="social-tab" id="tabFriends">Друзья</button>
      </div>
      <div class="social-grid">
        <div class="social-col">
          <div class="mini">Список</div>
          <div id="listUsers" class="social-list"></div>
        </div>
        <div class="social-col">
          <div class="mini">Детали</div>
          <div class="social-list">
            <div id="listRequests" style="display:none"></div>
            <div id="listFriends" style="display:none"></div>
            <div id="hintBox" class="mini">Выберите вкладку. Если Supabase не настроен — просто увидите подсказки.</div>
          </div>
          <div class="dm-panel" id="dmPanel">
            <div class="dm-head">
              <div class="dm-title">Чат</div><span class="mini" id="dmWith"></span><button class="dm-back" id="dmBack">Назад</button>
            </div>
            <div class="dm-list" id="dmList" aria-live="polite"></div>
            <div class="dm-input"><input type="text" id="dmInput" placeholder="Напишите сообщение другу…"><button id="dmSend">Отправить</button></div>
          </div>
        </div>
      </div>
      <div class="mini">Чтобы «Пользователи/Друзья/Чат» заработали между разными людьми, вставьте в код ваш <b>SUPABASE_URL</b> и <b>SUPABASE_ANON_KEY</b> (настройки проекта Supabase) и создайте таблицы.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="errban" id="errban"></div>

  <script>
  "use strict";
  (function(){
    /* Error banner */
    const errban = document.getElementById('errban');
    window.addEventListener('error', function(e){
      try{
        errban.textContent = 'JS error: ' + (e.error && e.error.message ? e.error.message : e.message);
        errban.style.display = 'block';
        setTimeout(()=>{ errban.style.display='none'; }, 7000);
      }catch(_){}
    });

    /* Screamer/BSOD */
    const moreBtn=document.getElementById('moreBtn');
    const screamer=document.getElementById('screamer');
    const bsod=document.getElementById('bsod');
    const screamSound=document.getElementById('screamSound');
    moreBtn.addEventListener('click',()=>{
      const el=document.documentElement;
      (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||(()=>{})).call(el);
      screamer.style.display='flex';
      try{ screamSound.currentTime=0; screamSound.play(); }catch(_){}
      setTimeout(()=>{ screamer.style.display='none'; bsod.style.display='flex'; },2000);
    });
    bsod.addEventListener('click',()=>location.reload());

    /* Show chat widget after load */
    window.addEventListener('load',()=>{ setTimeout(()=>document.body.classList.add('sv-show'), 800); });

    /* Chat widget */
    const svOpen=document.getElementById('sv-open');
    const svAd=document.getElementById('sv-ad');
    const svChat=document.getElementById('sv-chat');
    const svClose=document.getElementById('sv-close');
    const svMsgs=document.getElementById('sv-msgs');
    const svInput=document.getElementById('sv-input');
    const svSend=document.getElementById('sv-send');
    // --- Force enable & proper type for send buttons ---
    try {
      if (svSend) { svSend.setAttribute('type','button'); svSend.disabled = false; }
    } catch(e){}
    try {
      if (dmSend) { dmSend.setAttribute('type','button'); dmSend.disabled = false; }
    } catch(e){}

    svOpen.addEventListener('click',(e)=>{ e.preventDefault(); svAd.style.display='none'; svChat.style.display='flex'; setTimeout(()=>svInput.focus(),50); });
    svClose.addEventListener('click',()=>{ svChat.style.display='none'; svAd.style.display='flex'; });
    function addTyping(){ const w=document.createElement('div'); w.className='sv-msg sv-from'; w.id='typing'; w.innerHTML='<div class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>'; svMsgs.appendChild(w); svMsgs.scrollTop=svMsgs.scrollHeight; }
    function removeTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }
    function detectIntent(t){ const s=(t||'').toLowerCase(); if(/[^\w]?(прив|здра|хай|ку|салют)/.test(s)) return 'greet'; if(/(созвон|позвон|звонок|позвоним|свяжемся)/.test(s)) return 'call'; if(/[?]$/.test(s)) return 'question'; return 'other'; }
    function genReply(text){ const i=detectIntent(text); const r=a=>a[Math.floor(Math.random()*a.length)]; const f=['🙂','😉','✨','👍','📞','💬']; if(i==='call') return 'Ого, давай созвонимся! '+r(f); if(i==='greet') return r(['Привет! Как у тебя дела?','Приветик 😊 Чем могу помочь?','Салют! Что планируем?'])+' '+r(f); if(i==='question') return 'Хороший вопрос! '+r(['Скажи чуть подробнее?','Давай уточним детали.'])+' '+r(f); return r(['Поняла тебя.','Окей!','Супер!'])+' '+(text||'').trim(); }
    function aiRespond(userText){ const reply=genReply(userText); const delay=Math.min(2200,300+reply.length*20); addTyping(); setTimeout(()=>{ removeTyping(); const m=document.createElement('div'); m.className='sv-msg sv-from'; m.innerHTML='<b>Светлана:</b> '+reply; svMsgs.appendChild(m); svMsgs.scrollTop=svMsgs.scrollHeight; if(reply.includes('Ого, давай созвонимся!')){ setTimeout(()=>{ window.__callUI?.open(); }, 2000); } }, delay); }
    function sendMsg(){ const text=svInput.value.trim(); if(!text) return; const mine=document.createElement('div'); mine.className='sv-msg sv-to'; mine.innerHTML=`<b>Вы:</b> ${text}`; svMsgs.appendChild(mine); svInput.value=''; svMsgs.scrollTop=svMsgs.scrollHeight; aiRespond(text); }
    svSend.addEventListener('click',sendMsg); svInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMsg(); });

    /* Call UI with sounds + TTS */
    let actx=null, masterGain=null, rtGain=null, rtOsc1=null, rtOsc2=null, rtTick=null;
    function ensureAudio(){ if(!actx){ actx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=actx.createGain(); masterGain.gain.value=0.9; masterGain.connect(actx.destination); } if(actx.state==='suspended'){ actx.resume?.(); } }
    function stopRingtone(){ if(rtTick){ clearInterval(rtTick); rtTick=null; } try{ rtGain && (rtGain.gain.value=0); }catch(e){} try{ rtOsc1 && rtOsc1.stop(0); }catch(e){} try{ rtOsc2 && rtOsc2.stop(0); }catch(e){} rtGain=null; rtOsc1=null; rtOsc2=null; }
    function playRingtone(){ ensureAudio(); stopRingtone(); rtGain=actx.createGain(); rtGain.gain.value=0; rtGain.connect(masterGain); rtOsc1=actx.createOscillator(); rtOsc1.type='sine'; rtOsc1.frequency.value=440; rtOsc2=actx.createOscillator(); rtOsc2.type='sine'; rtOsc2.frequency.value=660; rtOsc1.connect(rtGain); rtOsc2.connect(rtGain); rtOsc1.start(); rtOsc2.start(); function burst(){ const now=actx.currentTime, g=rtGain.gain; g.cancelScheduledValues(now); g.setValueAtTime(0.0, now); g.linearRampToValueAtTime(0.22, now+0.02); g.setValueAtTime(0.22, now+0.38); g.linearRampToValueAtTime(0.0, now+0.42); g.setValueAtTime(0.0, now+0.62); g.linearRampToValueAtTime(0.22, now+0.64); g.setValueAtTime(0.22, now+1.00); g.linearRampToValueAtTime(0.0, now+1.04);} burst(); rtTick=setInterval(burst, 2600); }
    function blip(type){ ensureAudio(); const o=actx.createOscillator(), g=actx.createGain(); o.type='sine'; g.gain.value=0; o.connect(g).connect(masterGain); const now=actx.currentTime; if(type==='up'){ o.frequency.setValueAtTime(660, now); o.frequency.exponentialRampToValueAtTime(1200, now+0.16); g.gain.linearRampToValueAtTime(0.22, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.24); o.start(now); o.stop(now+0.26);} else { o.frequency.setValueAtTime(900, now); o.frequency.exponentialRampToValueAtTime(360, now+0.22); g.gain.linearRampToValueAtTime(0.22, now+0.02); g.gain.exponentialRampToValueAtTime(0.0001, now+0.24); o.start(now); o.stop(now+0.26);} }
    function pickRUVoice(){ const voices=window.speechSynthesis?speechSynthesis.getVoices():[]; if(!voices||!voices.length) return null; const ru=voices.filter(v=>(v.lang||'').toLowerCase().startsWith('ru')); const prefer=['milena','irina','tatiana','tatyana','oksana','katya','katia','anna','google русский','microsoft irina']; for(const name of prefer){ const v=ru.find(v=>v.name && v.name.toLowerCase().includes(name)); if(v) return v; } return ru[0]||voices[0]||null; }
    function ensureVoicesReady(){ return new Promise(res=>{ if(!('speechSynthesis' in window)) return res(false); const v=speechSynthesis.getVoices(); if(v && v.length) return res(true); const t=setTimeout(()=>res(true), 700); speechSynthesis.onvoiceschanged=()=>{ clearTimeout(t); res(true); }; }); }
    function speakRU(text,opts){ if(!('speechSynthesis' in window)) return false; const u=new SpeechSynthesisUtterance(text); u.lang='ru-RU'; u.rate=(opts&&opts.rate)||1; u.pitch=(opts&&opts.pitch)||1.15; u.volume=(opts&&opts.volume)||1; const v=pickRUVoice(); if(v) u.voice=v; try{ speechSynthesis.cancel(); }catch(_){ } try{ speechSynthesis.speak(u); return true; }catch(_){ return false; } }
    (function(){ const overlay=document.getElementById('callui'); const decline=document.getElementById('calluiDecline'); const accept=document.getElementById('calluiAccept'); const status=document.getElementById('calluiDesc'); const timer=document.getElementById('calluiTimer'); let callInterval=null, callStartTime=null; function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return m+':'+s; } function openUI(){ overlay.style.display='flex'; status.textContent='Входящий звонок'; timer.textContent=''; document.documentElement.style.overflow='hidden'; clearInterval(callInterval); callStartTime=null; playRingtone(); } function closeUI(playEnd){ overlay.style.display='none'; document.documentElement.style.overflow=''; clearInterval(callInterval); timer.textContent=''; callStartTime=null; stopRingtone(); if(playEnd!==false) blip('down'); } window.__callUI={open:openUI,close:closeUI}; decline.addEventListener('click',()=>closeUI(true)); accept.addEventListener('click',async ()=>{ stopRingtone(); blip('up'); status.textContent='Соединение…'; timer.textContent=''; clearInterval(callInterval); setTimeout(async ()=>{ status.textContent='Звонок идет'; callStartTime=Date.now(); timer.textContent='00:00'; callInterval=setInterval(()=>{ const s=Math.floor((Date.now()-callStartTime)/1000); timer.textContent=fmt(s); },1000); await ensureVoicesReady(); speakRU('Привет, это Светлана. Ты меня слышишь?', { pitch:1.2, rate:1.0 }); }, 1200); }); overlay.addEventListener('click',e=>{ if(e.target===overlay) closeUI(true); }); document.addEventListener('keydown',e=>{ if(e.key==='Escape' && overlay.style.display==='flex') closeUI(true); }); })();

    /* Toast helper */
    const toast = document.getElementById('toast');
    function showToast(msg, ms){ toast.textContent=msg; toast.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ toast.style.display='none'; }, ms||2200); }

    /* Auth (localStorage) */
    const authOverlay=document.getElementById('auth'); const authOpen=document.getElementById('authOpen'); const logoutBtn=document.getElementById('logoutBtn'); const hello=document.getElementById('hello'); const tabLogin=document.getElementById('tabLogin'); const tabRegister=document.getElementById('tabRegister'); const regNameWrap=document.getElementById('regNameWrap'); const regConfirmWrap=document.getElementById('regConfirmWrap'); const regName=document.getElementById('regName'); const authEmail=document.getElementById('authEmail'); const authPass=document.getElementById('authPass'); const authPass2=document.getElementById('authPass2'); const authSubmit=document.getElementById('authSubmit'); const authCancel=document.getElementById('authCancel'); const authError=document.getElementById('authError'); const authTitle=document.getElementById('authTitle'); let mode='login';
    function openAuth(wanted){ mode=wanted||'login'; authTitle.textContent=mode==='login'?'Вход':'Регистрация'; tabLogin.classList.toggle('active',mode==='login'); tabRegister.classList.toggle('active',mode==='register'); regNameWrap.style.display=mode==='register'?'':'none'; regConfirmWrap.style.display=mode==='register'?'':'none'; authEmail.value=''; authPass.value=''; authPass2.value=''; regName.value=''; authError.textContent=''; authOverlay.style.display='flex'; setTimeout(()=>authEmail.focus(),30); }
    function closeAuth(){ authOverlay.style.display='none'; }
    tabLogin.addEventListener('click',()=>openAuth('login')); tabRegister.addEventListener('click',()=>openAuth('register')); authOpen.addEventListener('click',()=>openAuth('login')); authCancel.addEventListener('click',closeAuth); authOverlay.addEventListener('click',e=>{ if(e.target===authOverlay) closeAuth(); });
    function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
    function sha256(str){ const enc=new TextEncoder().encode(str); return crypto.subtle.digest('SHA-256', enc).then(buf=>{ const b=new Uint8Array(buf); let s=''; for(let i=0;i<b.length;i++){ s+=String.fromCharCode(b[i]); } return btoa(s); }); }
    function getUser(){ try{ return JSON.parse(localStorage.getItem('sv_user')||'null'); }catch(e){ return null; } }
    function setUser(u){ localStorage.setItem('sv_user', JSON.stringify(u)); }
    function clearUser(){ localStorage.removeItem('sv_user'); }
    function updateAuthUI(){ const u=getUser(); if(u){ hello.textContent='Привет, '+(u.name||u.email); authOpen.style.display='inline-block'; authOpen.textContent='Аккаунт'; logoutBtn.style.display='inline-block'; } else { hello.textContent=''; authOpen.style.display='inline-block'; authOpen.textContent='Войти / Регистрация'; logoutBtn.style.display='none'; } }
    logoutBtn.addEventListener('click',()=>{ clearUser(); updateAuthUI(); showToast('Вы вышли из аккаунта'); });

    authSubmit.addEventListener('click', async ()=>{
      const email = (authEmail.value||'').trim().toLowerCase();
      const pass  = (authPass.value||'');
      const name  = (regName.value||'').trim();
      if(!isValidEmail(email)){ authError.textContent='Введите корректный email'; return; }
      if(pass.length<6){ authError.textContent='Пароль от 6 символов'; return; }
      if(mode==='register'){
        if(pass !== authPass2.value){ authError.textContent='Пароли не совпадают'; return; }
        const passHash = await sha256(pass);
        const db = JSON.parse(localStorage.getItem('sv_users')||'{}');
        if(db[email]){ authError.textContent='Email уже зарегистрирован'; return; }
        db[email] = { passHash, name, createdAt: Date.now() };
        localStorage.setItem('sv_users', JSON.stringify(db));
        setUser({ email, name });
        closeAuth(); updateAuthUI(); showToast('Регистрация выполнена');
        syncProfileToSupabase().catch(()=>{});
      } else {
        const db = JSON.parse(localStorage.getItem('sv_users')||'{}');
        if(!db[email]){ authError.textContent='Пользователь не найден. Зарегистрируйтесь.'; return; }
        const passHash = await sha256(pass);
        if(db[email].passHash !== passHash){ authError.textContent='Неверный пароль'; return; }
        setUser({ email, name: db[email].name });
        closeAuth(); updateAuthUI(); showToast('Вход выполнен');
        syncProfileToSupabase().catch(()=>{});
      }
    });
    updateAuthUI();

    /* Social / Supabase (safe guards) */
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // вставьте свои при необходимости
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";
    let sb = null;
    try{
      if(typeof supabase!=='undefined' && SUPABASE_URL.startsWith('http') && SUPABASE_ANON_KEY.length>20){
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    }catch(e){
      console.warn('Supabase init failed', e);
    }
    function sbReady(){ return !!sb; }

    const socialOverlay=document.getElementById('social'); const socialOpen=document.getElementById('socialOpen'); const socialClose=document.getElementById('socialClose');
    const tabUsers=document.getElementById('tabUsers'); const tabRequests=document.getElementById('tabRequests'); const tabFriends=document.getElementById('tabFriends');
    const listUsers=document.getElementById('listUsers'); const listRequests=document.getElementById('listRequests'); const listFriends=document.getElementById('listFriends');
    const hintBox=document.getElementById('hintBox'); const socialStatus=document.getElementById('socialStatus');
    const dmPanel=document.getElementById('dmPanel'); const dmWith=document.getElementById('dmWith'); const dmList=document.getElementById('dmList'); const dmInput=document.getElementById('dmInput'); const dmSend=document.getElementById('dmSend'); const dmBack=document.getElementById('dmBack');

    // --- Force enable & proper type for send buttons ---
    try {
      if (svSend) { svSend.setAttribute('type','button'); svSend.disabled = false; }
    } catch(e){}
    try {
      if (dmSend) { dmSend.setAttribute('type','button'); dmSend.disabled = false; }
    } catch(e){}

    socialOpen.addEventListener('click', ()=>{ socialOverlay.style.display='flex'; setTab('users'); refreshAll(); });
    socialClose.addEventListener('click', ()=>{ socialOverlay.style.display='none'; });
    socialOverlay.addEventListener('click', e=>{ if(e.target===socialOverlay) socialOverlay.style.display='none'; });
    function setTab(tab){ tabUsers.classList.toggle('active', tab==='users'); tabRequests.classList.toggle('active', tab==='requests'); tabFriends.classList.toggle('active', tab==='friends'); listRequests.style.display = tab==='requests' ? '' : 'none'; listFriends.style.display = tab==='friends' ? '' : 'none'; hintBox.style.display = tab==='users' ? '' : 'none'; }
    tabUsers.addEventListener('click', ()=>{ setTab('users'); refreshUsers(); });
    tabRequests.addEventListener('click', ()=>{ setTab('requests'); refreshRequests(); });
    tabFriends.addEventListener('click', ()=>{ setTab('friends'); refreshFriends(); });

    function setStatus(t){ socialStatus.textContent=t||''; }
    function getMe(){ return getUser(); }

    function renderUserItem(p){ const me=getMe(); const isMe=me&&me.email===p.email; const wrap=document.createElement('div'); wrap.className='social-item'; wrap.innerHTML = `<div><div class="social-name">${p.name||p.email}</div><div class="social-email">${p.email}</div></div>`; const actions=document.createElement('div'); actions.className='social-actions'; if(!isMe){ const btn=document.createElement('button'); btn.className='act'; btn.textContent='Добавить'; btn.addEventListener('click', ()=>sendRequest(p.email)); actions.appendChild(btn);} else { const meb=document.createElement('span'); meb.className='mini'; meb.textContent='это вы'; actions.appendChild(meb);} wrap.appendChild(actions); return wrap; }
    function renderRequestItem(r){ const wrap=document.createElement('div'); wrap.className='social-item'; wrap.innerHTML = `<div><div class="social-name">Заявка от</div><div class="social-email">${r.from_email}</div></div>`; const actions=document.createElement('div'); actions.className='social-actions'; const acc=document.createElement('button'); acc.className='act'; acc.textContent='Принять'; acc.onclick=()=>acceptRequest(r.id); const dec=document.createElement('button'); dec.className='muted'; dec.textContent='Отклонить'; dec.onclick=()=>declineRequest(r.id); actions.appendChild(acc); actions.appendChild(dec); wrap.appendChild(actions); return wrap; }
    function renderFriendItem(f){ const wrap=document.createElement('div'); wrap.className='social-item'; wrap.innerHTML = `<div><div class="social-name">${f.name||f.email}</div><div class="social-email">${f.email}</div></div>`; const actions=document.createElement('div'); actions.className='social-actions'; const chat=document.createElement('button'); chat.className='act'; chat.textContent='Открыть чат'; chat.onclick=()=>openDM(f.email, f.name||f.email); const rm=document.createElement('button'); rm.className='danger'; rm.textContent='Удалить'; rm.onclick=()=>removeFriendship(f.email); actions.appendChild(chat); actions.appendChild(rm); wrap.appendChild(actions); return wrap; }

    async function refreshUsers(){ listUsers.innerHTML=''; if(!sbReady()){ setStatus('Supabase не настроен'); listUsers.innerHTML='<div class="mini">Вставьте ключи Supabase, чтобы видеть других пользователей</div>'; return; } const q=await sb.from('profiles').select('email,name,created_at').order('created_at',{ascending:false}).limit(200); if(q.error){ setStatus('Ошибка: '+q.error.message); return; } setStatus('Пользователей: '+q.data.length); q.data.forEach(p=> listUsers.appendChild(renderUserItem(p))); }
    async function refreshRequests(){ listRequests.innerHTML=''; if(!sbReady()){ setStatus('Supabase не настроен'); listRequests.innerHTML='<div class="mini">Подключите Supabase</div>'; return; } const me=getMe(); if(!me){ setStatus('Войдите, чтобы видеть заявки'); return; } const q=await sb.from('friend_requests').select('id,from_email,to_email,status,created_at').eq('to_email',me.email).eq('status','pending').order('created_at',{ascending:false}); if(q.error){ setStatus('Ошибка: '+q.error.message); return; } setStatus('Заявок: '+q.data.length); q.data.forEach(r=> listRequests.appendChild(renderRequestItem(r))); }
    async function refreshFriends(){ listFriends.innerHTML=''; if(!sbReady()){ setStatus('Supabase не настроен'); listFriends.innerHTML='<div class="mini">Подключите Supabase</div>'; return; } const me=getMe(); if(!me){ setStatus('Войдите, чтобы видеть друзей'); return; } const a=await sb.from('friend_requests').select('id,from_email,to_email,status,created_at').eq('status','accepted').eq('from_email',me.email); const b=await sb.from('friend_requests').select('id,from_email,to_email,status,created_at').eq('status','accepted').eq('to_email',me.email); if(a.error||b.error){ setStatus('Ошибка: '+(a.error||b.error).message); return; } const rows=[...(a.data||[]),...(b.data||[])]; const emails=[]; rows.forEach(r=>{ const other=r.from_email===me.email ? r.to_email : r.from_email; if(!emails.includes(other)) emails.push(other); }); if(!emails.length){ setStatus('Друзей пока нет'); return; } const prof=await sb.from('profiles').select('email,name').in('email', emails); if(prof.error){ setStatus('Ошибка: '+prof.error.message); return; } prof.data.forEach(p=> listFriends.appendChild(renderFriendItem(p))); setStatus('Друзей: '+prof.data.length); }

    async function sendRequest(toEmail){ const me=getMe(); if(!me){ openAuth('login'); showToast('Войдите, чтобы добавлять в друзья'); return; } if(!sbReady()){ showToast('Supabase не настроен'); return; } if(me.email===toEmail){ showToast('Самого себя нельзя'); return; } const r1=await sb.from('friend_requests').select('id,from_email,to_email,status').eq('from_email',me.email).eq('to_email',toEmail).limit(1); const r2=await sb.from('friend_requests').select('id,from_email,to_email,status').eq('from_email',toEmail).eq('to_email',me.email).limit(1); if(r1.error||r2.error){ showToast('Ошибка: '+(r1.error||r2.error).message); return; } const ex=[...(r1.data||[]),...(r2.data||[])]; if(ex.length){ const r=ex[0]; if(r.status==='accepted'){ showToast('Вы уже друзья'); return; } if(r.from_email===me.email && r.status==='pending'){ showToast('Заявка уже отправлена'); return; } if(r.from_email===toEmail && r.status==='pending'){ setTab('requests'); showToast('У вас есть входящая заявка'); refreshRequests(); return; } }
      const ins=await sb.from('friend_requests').upsert({from_email:me.email,to_email:toEmail,status:'pending'},{onConflict:'from_email,to_email'});
      if(ins.error){ showToast('Ошибка: '+ins.error.message); } else { showToast('Заявка отправлена'); refreshRequests(); } }

    async function acceptRequest(id){ if(!sbReady()) return; const q=await sb.from('friend_requests').update({status:'accepted'}).eq('id',id); if(q.error){ showToast('Ошибка: '+q.error.message); } else { showToast('Заявка принята'); refreshFriends(); refreshRequests(); } }
    async function declineRequest(id){ if(!sbReady()) return; const q=await sb.from('friend_requests').update({status:'declined'}).eq('id',id); if(q.error){ showToast('Ошибка: '+q.error.message); } else { showToast('Отклонено'); refreshRequests(); } }
    async function removeFriendship(otherEmail){ if(!sbReady()) return; const me=getMe(); if(!me) return; const d1=await sb.from('friend_requests').delete().eq('status','accepted').eq('from_email',me.email).eq('to_email',otherEmail); const d2=await sb.from('friend_requests').delete().eq('status','accepted').eq('from_email',otherEmail).eq('to_email',me.email); if(d1.error||d2.error){ showToast('Ошибка: '+(d1.error||d2.error).message); } else { showToast('Удалено'); refreshFriends(); } }

    /* DM (messages) */
    let dmOtherEmail=null, dmOtherName=null, dmTimer=null;
    function openDM(email,name){ const me=getMe(); if(!me){ openAuth('login'); showToast('Войдите, чтобы писать'); return; } if(!sbReady()){ showToast('Supabase не настроен'); return; } dmOtherEmail=email; dmOtherName=name||email; dmWith.textContent='с '+dmOtherName+' ('+dmOtherEmail+')'; dmPanel.style.display='block'; dmList.innerHTML=''; stopDM(); fetchMessages(); dmTimer=setInterval(fetchMessages,2000); }
    function stopDM(){ if(dmTimer){ clearInterval(dmTimer); dmTimer=null; } }
    dmBack.addEventListener('click', ()=>{ stopDM(); dmPanel.style.display='none'; dmOtherEmail=null; dmOtherName=null; });
    function renderDMItem(msg){ const me=getMe(); const mine=me && msg.from_email===me.email; const div=document.createElement('div'); div.className='dm-msg '+(mine?'dm-me':'dm-other'); const t=new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); div.innerHTML=(mine?'':('<b>'+(dmOtherName||msg.from_email)+':</b> '))+escapeHtml(msg.body)+'<span class="dm-time">'+t+'</span>'; return div; }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    async function fetchMessages(){ if(!sbReady()) return; const me=getMe(); if(!me||!dmOtherEmail) return; const a=await sb.from('messages').select('id,from_email,to_email,body,created_at').eq('from_email',me.email).eq('to_email',dmOtherEmail); const b=await sb.from('messages').select('id,from_email,to_email,body,created_at').eq('from_email',dmOtherEmail).eq('to_email',me.email); if(a.error||b.error){ setStatus('Ошибка сообщений: '+(a.error||b.error).message); return; } const data=[...(a.data||[]),...(b.data||[])].sort((x,y)=>new Date(x.created_at)-new Date(y.created_at)); dmList.innerHTML=''; data.forEach(m=> dmList.appendChild(renderDMItem(m))); dmList.scrollTop=dmList.scrollHeight; }
    async function sendDM(){ const text=(dmInput.value||'').trim(); if(!text||!dmOtherEmail) return; const me=getMe(); if(!me){ openAuth('login'); return; } if(!sbReady()){ showToast('Supabase не настроен'); return; } dmSend.disabled=true; const ins=await sb.from('messages').insert({from_email:me.email,to_email:dmOtherEmail,body:text}); dmSend.disabled=false; if(ins.error){ showToast('Ошибка отправки: '+ins.error.message); return; } dmInput.value=''; fetchMessages(); }
    dmSend.addEventListener('click', sendDM); dmInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ sendDM(); } });

    async function refreshAll(){ await syncProfileToSupabase().catch(()=>{}); await refreshUsers(); await refreshRequests(); await refreshFriends(); }

    /* Sync profile */
    async function syncProfileToSupabase(){ if(!sbReady()) return; const u=getUser(); if(!u) return; const up=await sb.from('profiles').upsert({ email:u.email, name:u.name||u.email }); if(up.error) console.warn(up.error); }
  })();
  </script>
</body>
</html>
